<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tes Profil DISC - Perekrutan</title>
    <!-- Load Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Firebase Modules -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, orderBy, onSnapshot, setDoc, doc, serverTimestamp, getDoc, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- GLOBAL SETUP ---
        // Global variables provided by the environment (Canvas)
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        if (!firebaseConfig) {
            console.error("Konfigurasi Firebase tidak ditemukan. Penyimpanan hasil tidak akan berfungsi.");
            document.addEventListener('DOMContentLoaded', () => {
                document.getElementById('app-container').innerHTML = `
                    <div class="text-center p-8 bg-red-100 border border-red-400 text-red-700 rounded-xl shadow-xl">
                        <p class="font-bold">Kesalahan Fatal:</p>
                        <p>Konfigurasi Firebase tidak ditemukan. Aplikasi tidak dapat berjalan.</p>
                    </div>
                `;
            });
            throw new Error("Firebase configuration not found. Application aborted."); 
        }

        // Define DISC question set
        const discQuestions = [
            { id: 1, choices: { D: "Mendorong", I: "Ramah", S: "Tenang", C: "Akurat" } },
            { id: 2, choices: { D: "Tegas", I: "Optimis", S: "Sabar", C: "Analitis" } },
            { id: 3, choices: { D: "Kuat", I: "Ekspresif", S: "Stabil", C: "Logis" } },
            { id: 4, choices: { D: "Berani", I: "Antusias", S: "Konsisten", C: "Perfeksionis" } },
            { id: 5, choices: { D: "Menantang", I: "Sosial", S: "Penuh Perhatian", C: "Hati-hati" } },
            { id: 6, choices: { D: "Berorientasi Hasil", I: "Persuasif", S: "Setia", C: "Tepat" } },
            { id: 7, choices: { D: "Independen", I: "Ceria", S: "Pendengar yang Baik", C: "Teratur" } },
            { id: 8, choices: { D: "Lugas", I: "Komunikatif", S: "Damai", C: "Kritis" } },
            { id: 9, choices: { D: "Bertekad", I: "Fleksibel", S: "Mudah Diajak Kerjasama", C: "Teliti" } },
            { id: 10, choices: { D: "Inovatif", I: "Spontan", S: "Hormat", C: "Standar Tinggi" } },
        ];
        
        // --- APPLICATION STATE (Global Variables) ---
        let db = null;
        let userId = null;
        let auth = null;
        let sharerId = null;
        let isAuthReady = false;
        let currentPage = 'welcome';
        let currentAnswers = discQuestions.map(() => ({ most: null, least: null }));
        let profileResult = null;
        let resultsHistory = [];
        let unsubscribeSheet = null; // For cleanup

        // --- FIREBASE AND AUTHENTICATION LOGIC ---

        const setupSharerId = async (firestore, currentUid) => {
            if (!currentUid) return;
            // Document reference must have an even number of segments (C/D/C/D/C/D)
            // Path: artifacts/{appId}/public/data/metadata/sharer_id_doc
            const sharerDocRef = doc(firestore, `artifacts/${appId}/public/data/metadata/sharer_id_doc`);
            
            try {
                const docSnap = await getDoc(sharerDocRef);
                
                if (docSnap.exists()) {
                    sharerId = docSnap.data().sharerId;
                } else {
                    // First user sets the sharerId (The Admin/Recruiter)
                    await setDoc(sharerDocRef, { sharerId: currentUid });
                    sharerId = currentUid;
                    console.log("Sharer ID baru disimpan:", currentUid);
                }
            } catch (e) {
                console.error("Gagal mengatur/memuat Sharer ID:", e);
                // Fallback
                sharerId = currentUid; 
            }
        };

        const initializeFirebase = () => {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            onAuthStateChanged(auth, async (user) => {
                let currentUid;
                if (user) {
                    currentUid = user.uid;
                } else {
                    try {
                        if (initialAuthToken) {
                            const credential = await signInWithCustomToken(auth, initialAuthToken);
                            currentUid = credential.user.uid;
                        } else {
                            const credential = await signInAnonymously(auth);
                            currentUid = credential.user.uid;
                        }
                    } catch (e) {
                        console.error("Gagal melakukan sign-in Firebase:", e);
                        currentUid = null;
                    }
                }
                
                userId = currentUid;
                await setupSharerId(db, userId); 
                isAuthReady = true;
                updateUI();
            });
        };

        // --- DISC LOGIC ---

        const handleSelection = (questionIndex, type, value) => {
            const currentQ = currentAnswers[questionIndex];
            
            if (type === 'most') {
                if (currentQ.least === value) {
                    currentQ.least = null;
                }
                currentQ.most = value;
            } else { // type === 'least'
                if (currentQ.most === value) {
                    currentQ.most = null;
                }
                currentQ.least = value;
            }
            updateUI(); // Re-render the test page to reflect selection
        };
        
        const calculateDISC = () => {
            const scores = { D: 0, I: 0, S: 0, C: 0 };

            currentAnswers.forEach((answer, index) => {
                const choices = discQuestions[index].choices;

                // Increment score for 'Most'
                if (answer.most) {
                    const type = Object.keys(choices).find(key => choices[key] === answer.most);
                    if (type) scores[type] += 1;
                }

                // Decrement score for 'Least'
                if (answer.least) {
                    const type = Object.keys(choices).find(key => choices[key] === answer.least);
                    if (type) scores[type] -= 1;
                }
            });

            // Determine the highest score (Primary Profile)
            const sortedScores = Object.entries(scores).sort(([, a], [, b]) => b - a);
            const maxScore = sortedScores[0][1];
            const primaryRawType = sortedScores.filter(([, score]) => score === maxScore).map(([type]) => type).join('/');
            
            const primaryProfileMap = {
                D: 'Dominance (Kekuasaan)',
                I: 'Influence (Pengaruh)',
                S: 'Steadiness (Keteguhan)',
                C: 'Conscientiousness (Kepatuhan)',
                'D/I': 'Dominance/Influence (Pendorong & Persuasif)',
                'I/D': 'Influence/Dominance (Persuasif & Pendorong)',
                'S/C': 'Steadiness/Conscientiousness (Teliti & Stabil)',
                'C/S': 'Conscientiousness/Steadiness (Teliti & Stabil)',
                'D/S': 'Dominance/Steadiness (Tegas & Stabil)',
                'I/S': 'Influence/Steadiness (Ramah & Stabil)',
                'I/C': 'Influence/Conscientiousness (Ramah & Teliti)',
                'C/D': 'Conscientiousness/Dominance (Teliti & Tegas)'
            };
            
            const finalPrimaryKey = primaryRawType.split('/').sort().join('/');

            return {
                scores: scores,
                primaryType: primaryProfileMap[finalPrimaryKey] || primaryProfileMap[primaryRawType] || primaryProfileMap[primaryRawType.split('/')[0]],
                rawProfile: primaryRawType,
            };
        };

        const handleSubmitTest = async () => {
            const isComplete = currentAnswers.every(a => a.most !== null && a.least !== null);
            if (!isComplete) {
                console.warn("Harap jawab semua pertanyaan (pilih 'Paling' dan 'Paling Tidak' untuk setiap nomor) sebelum mengirim.");
                // Custom modal for incomplete test
                const appContainer = document.getElementById('app-container');
                appContainer.insertAdjacentHTML('afterbegin', `
                    <div id="error-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div class="bg-white p-6 rounded-lg shadow-2xl">
                            <h3 class="text-xl font-bold text-red-600 mb-4">Tes Belum Selesai!</h3>
                            <p>Harap jawab semua 10 pertanyaan (pilih "Paling" dan "Paling Tidak" untuk setiap nomor) sebelum mengirim.</p>
                            <button onclick="document.getElementById('error-modal').remove()" class="mt-4 px-4 py-2 bg-red-500 text-white rounded">Tutup</button>
                        </div>
                    </div>
                `);
                return;
            }

            const result = calculateDISC();
            profileResult = result;
            currentPage = 'results';
            
            // Save results to Public Collection, linked to the Sharer ID
            if (db && userId && sharerId) {
                try {
                    // Collection Path: artifacts/{appId}/public/data/results
                    const resultsCollectionRef = collection(db, `artifacts/${appId}/public/data/results`);
                    const docRef = doc(resultsCollectionRef);
                    
                    await setDoc(docRef, {
                        timestamp: serverTimestamp(),
                        sharerId: sharerId,
                        candidateId: userId,
                        profile: result.primaryType,
                        rawScores: result.scores,
                        rawProfile: result.rawProfile,
                    });
                    console.log("Hasil tes disimpan dengan ID:", docRef.id, "untuk Sharer ID:", sharerId);
                } catch (e) {
                    console.error("Gagal menyimpan hasil ke Firestore:", e);
                    // Update UI error state if necessary
                }
            }
            updateUI();
        };

        const fetchResultsHistory = () => {
            if (!db || !userId || !sharerId || userId !== sharerId) {
                resultsHistory = [];
                // If the user is not the sharer, we still proceed to render, but the sheet will be empty/show a warning
                updateUI(); 
                return;
            }

            if (unsubscribeSheet) {
                unsubscribeSheet(); 
            }
            
            const resultsCollectionRef = collection(db, `artifacts/${appId}/public/data/results`);
            
            const q = query(
                resultsCollectionRef, 
                where("sharerId", "==", userId),
                orderBy("timestamp", "desc")
            );

            unsubscribeSheet = onSnapshot(q, (snapshot) => {
                resultsHistory = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    // Convert timestamp if it's available
                    timestamp: doc.data().timestamp ? new Date(doc.data().timestamp.seconds * 1000).toLocaleString('id-ID') : 'N/A'
                }));
                updateUI(); // Re-render the sheet page with new data
            }, (e) => {
                console.error("Gagal mengambil riwayat hasil:", e);
                // Set error state if needed
                updateUI();
            });
        };

        // --- RENDERING FUNCTIONS (similar to React components) ---

        const renderWelcome = () => {
            let sharerInfo = '';
            if (sharerId) {
                sharerInfo = `
                    <div class="text-left mb-6 p-4 border-l-4 border-purple-500 bg-purple-50 rounded">
                        <p class="font-semibold text-purple-700">Untuk Admin (Perekrut):</p>
                        <p class="text-sm text-gray-700 mt-1">Semua hasil tes akan terhubung ke <strong>Sharer ID</strong> ini:</p>
                        <p class="font-mono text-sm text-purple-900 break-all p-1 bg-purple-100 rounded mt-1">${sharerId}</p>
                        <p class="text-sm text-gray-700 mt-2">Pastikan Anda menggunakan ID ini untuk melihat 'Sheet' hasil.</p>
                    </div>
                `;
            }

            return `
                <div class="text-center p-8 bg-white shadow-xl rounded-xl w-full max-w-xl">
                    <h1 class="text-3xl font-extrabold text-blue-700 mb-4">Tes Profil DISC</h1>
                    <p class="text-gray-600 mb-6">Tes ini akan membantu mengidentifikasi kecenderungan perilaku Anda dalam empat dimensi utama: Dominance (D), Influence (I), Steadiness (S), dan Conscientiousness (C).</p>
                    
                    ${sharerInfo}

                    <div class="text-left mb-6 p-4 border-l-4 border-yellow-500 bg-yellow-50 rounded">
                        <p class="font-semibold text-yellow-700">Instruksi Penting:</p>
                        <ul class="list-disc list-inside text-gray-700 text-sm mt-2">
                            <li>Anda akan melihat <strong>10 set</strong> pernyataan.</li>
                            <li>Untuk setiap set, Anda harus memilih <strong>SATU</strong> kata yang <strong>PALING</strong> menggambarkan diri Anda.</li>
                            <li>Anda juga harus memilih <strong>SATU</strong> kata yang <strong>PALING TIDAK</strong> menggambarkan diri Anda.</li>
                            <li>Pastikan Anda memilih <strong>kedua</strong> opsi (Paling dan Paling Tidak) di setiap nomor.</li>
                        </ul>
                    </div>

                    <button
                        onclick="goToPage('test')"
                        ${!sharerId ? 'disabled' : ''}
                        class="px-8 py-3 bg-blue-600 text-white font-bold rounded-lg shadow-lg hover:bg-blue-700 transition duration-300 transform hover:scale-105 disabled:bg-gray-400"
                    >
                        Mulai Tes
                    </button>
                    ${!isAuthReady ? '<p class="mt-4 text-sm text-gray-500">Memuat konfigurasi...</p>' : ''}
                </div>
            `;
        };
        
        const renderTest = () => {
            const completedCount = currentAnswers.filter(a => a.most !== null && a.least !== null).length;
            
            const questionHtml = discQuestions.map((q, index) => {
                const choicesHtml = Object.values(q.choices).map((choice, choiceIndex) => {
                    const isMostSelected = currentAnswers[index].most === choice;
                    const isLeastSelected = currentAnswers[index].least === choice;
                    const isDisabled = (isMostSelected && isLeastSelected); 

                    return `
                        <div class="flex flex-col p-3 rounded-lg transition duration-150 ${isDisabled ? 'bg-gray-100' : 'bg-gray-50 hover:bg-gray-100'}">
                            <span class="font-medium text-gray-700 mb-2">${choice}</span>
                            <div class="flex space-x-3">
                                <label class="flex items-center space-x-1 cursor-pointer">
                                    <input
                                        type="checkbox"
                                        onchange="handleSelection(${index}, 'most', '${choice}')"
                                        ${isMostSelected ? 'checked' : ''}
                                        ${isLeastSelected || isDisabled ? 'disabled' : ''}
                                        class="form-checkbox h-5 w-5 ${isLeastSelected ? 'text-gray-400' : 'text-green-500'}"
                                    />
                                    <span class="text-sm">Paling</span>
                                </label>
                                <label class="flex items-center space-x-1 cursor-pointer">
                                    <input
                                        type="checkbox"
                                        onchange="handleSelection(${index}, 'least', '${choice}')"
                                        ${isLeastSelected ? 'checked' : ''}
                                        ${isMostSelected || isDisabled ? 'disabled' : ''}
                                        class="form-checkbox h-5 w-5 ${isMostSelected ? 'text-gray-400' : 'text-red-500'}"
                                    />
                                    <span class="text-sm">Paling Tidak</span>
                                </label>
                            </div>
                        </div>
                    `;
                }).join('');

                const warning = !(currentAnswers[index].most && currentAnswers[index].least) ? 
                    `<p class="mt-3 text-red-500 text-xs font-medium">Harap pilih satu "Paling" dan satu "Paling Tidak".</p>` : '';

                return `
                    <div class="p-4 border border-gray-200 rounded-lg shadow-sm hover:shadow-md transition duration-200">
                        <p class="font-semibold text-lg mb-4 text-blue-600">Pertanyaan ${q.id}. Pilih SATU Paling dan SATU Paling Tidak:</p>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">${choicesHtml}</div>
                        ${warning}
                    </div>
                `;
            }).join('');

            const isComplete = completedCount === discQuestions.length;
            const buttonClass = isComplete ? 'bg-green-600 hover:bg-green-700' : 'bg-gray-400 cursor-not-allowed';

            return `
                <div class="p-4 md:p-8 bg-white shadow-xl rounded-xl max-w-4xl mx-auto w-full">
                    <h1 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-3">Sesi Tes DISC (${completedCount}/${discQuestions.length} Terjawab)</h1>
                    <p class="mb-4 text-sm text-gray-600">ID Anda (Kandidat): <span class="font-mono text-xs p-1 bg-gray-200 rounded break-all">${userId || 'N/A'}</span></p>

                    <div class="grid grid-cols-1 gap-8">${questionHtml}</div>

                    <div class="mt-8 flex justify-center">
                        <button
                            onclick="handleSubmitTest()"
                            ${!isComplete ? 'disabled' : ''}
                            class="px-10 py-4 ${buttonClass} text-white font-bold text-lg rounded-lg shadow-lg transition duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed"
                        >
                            Lihat Hasil & Simpan ke Sheet
                        </button>
                    </div>
                </div>
            `;
        };
        
        const renderResults = () => {
            if (!profileResult) return '<p class="text-center text-red-500">Tidak ada hasil yang ditemukan.</p>';

            const { primaryType, rawScores, rawProfile } = profileResult;
            
            const profileColorMap = {
                D: 'bg-red-500', I: 'bg-yellow-500', S: 'bg-green-500', C: 'bg-blue-500',
                'D/I': 'bg-gradient-to-r from-red-500 to-yellow-500',
                'I/D': 'bg-gradient-to-r from-yellow-500 to-red-500',
                'S/C': 'bg-gradient-to-r from-green-500 to-blue-500',
                'C/S': 'bg-gradient-to-r from-blue-500 to-green-500',
            };
            const profileDescMap = {
                'Dominance (Kekuasaan)': 'Berorientasi pada hasil, tegas, pemecah masalah, dan menyukai tantangan.',
                'Influence (Pengaruh)': 'Sosial, optimis, antusias, dan persuasif. Suka bekerja dalam tim.',
                'Steadiness (Keteguhan)': 'Sabar, tenang, setia, suportif, dan menghargai stabilitas.',
                'Conscientiousness (Kepatuhan)': 'Analitis, akurat, hati-hati, fokus pada kualitas dan detail.',
            };

            const getPrimaryTypeClass = () => {
                const types = rawProfile.split('/');
                if (types.length === 1) return profileColorMap[types[0]] || 'bg-gray-400';
                const sortedType = types.sort().join('/'); 
                return profileColorMap[sortedType] || 'bg-gray-400';
            };
            
            const scoreHtml = Object.entries(rawScores).map(([type, score]) => `
                <div class="text-center p-4 border rounded-lg shadow-md bg-white">
                    <p class="text-lg font-semibold text-gray-700">${type}</p>
                    <p class="text-4xl font-extrabold text-blue-600 mt-1">${score}</p>
                </div>
            `).join('');

            return `
                <div class="p-8 bg-white shadow-2xl rounded-xl max-w-4xl mx-auto w-full">
                    <h1 class="text-3xl font-extrabold text-green-700 text-center mb-6">HASIL TES PROFIL DISC ANDA</h1>
                    
                    <div class="text-center p-6 mb-8 rounded-lg shadow-inner bg-blue-50 border border-blue-200">
                        <p class="text-xl text-gray-700 mb-2">Profil Dominan Anda adalah:</p>
                        <h2 class="text-4xl font-black text-white p-4 rounded-lg inline-block ${getPrimaryTypeClass()} shadow-xl">
                            ${primaryType}
                        </h2>
                        <p class="mt-4 text-gray-600 italic">${profileDescMap[primaryType.split('(')[0].trim()] || "Lihat skor di bawah untuk detail lebih lanjut."}</p>
                    </div>

                    <h3 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Skor Anda:</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">${scoreHtml}</div>

                    <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4">
                        <button
                            onclick="resetTestAndGoToPage('test')"
                            class="px-6 py-3 border border-blue-600 text-blue-600 font-semibold rounded-lg hover:bg-blue-50 transition duration-300"
                        >
                            Ulangi Tes
                        </button>
                        <button
                            onclick="goToPage('sheet')"
                            class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-lg hover:bg-indigo-700 transition duration-300"
                        >
                            Lihat "Sheet" Hasil (Riwayat)
                        </button>
                    </div>
                </div>
            `;
        };
        
        const renderSheet = () => {
            const isAdmin = userId === sharerId;
            let errorHtml = '';
            
            if (!isAdmin) {
                errorHtml = `
                    <p class="text-center text-lg text-red-500 py-10">
                        Anda bukan administrator. Hanya pemilik Sharer ID yang dapat melihat hasil tes.
                    </p>
                `;
            } else if (resultsHistory.length === 0) {
                 errorHtml = `
                    <p class="text-center text-lg text-gray-500 py-10">
                        Belum ada riwayat hasil yang tersimpan di bawah Sharer ID Anda.
                    </p>
                `;
            }

            let tableHtml = '';
            if (resultsHistory.length > 0 && isAdmin) {
                const rows = resultsHistory.map((result, index) => `
                    <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${result.timestamp}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 break-all">${result.candidateId || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900">${result.profile}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                            D: ${result.rawScores?.D}, I: ${result.rawScores?.I}, S: ${result.rawScores?.S}, C: ${result.rawScores?.C}
                        </td>
                    </tr>
                `).join('');

                tableHtml = `
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID Kandidat</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Profil Utama</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Skor Mentah (D/I/S/C)</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">${rows}</tbody>
                        </table>
                    </div>
                `;
            }

            return `
                <div class="p-4 md:p-8 bg-white shadow-xl rounded-xl max-w-4xl mx-auto w-full">
                    <h1 class="text-3xl font-extrabold text-indigo-700 mb-6 border-b pb-3">Riwayat Hasil Tes DISC Anda ("Sheet")</h1>
                    
                    <p class="mb-4 text-sm text-gray-600">
                        Hasil ini difilter berdasarkan <strong>Sharer ID</strong> Anda: <span class="font-mono text-xs p-1 bg-gray-200 rounded break-all">${sharerId || 'N/A'}</span>
                        <span class="ml-4 font-bold text-green-700"> (Hanya Sharer ID yang dapat melihat ini)</span>
                    </p>

                    ${errorHtml || tableHtml}

                    <div class="mt-8 text-center">
                        <button
                            onclick="goToPage('welcome')"
                            class="px-6 py-3 border border-gray-600 text-gray-600 font-semibold rounded-lg hover:bg-gray-100 transition duration-300"
                        >
                            Kembali ke Beranda
                        </button>
                    </div>
                </div>
            `;
        };

        // --- CORE UI CONTROLLER ---

        window.goToPage = (page) => {
            if (page === 'sheet') {
                if (unsubscribeSheet) {
                    unsubscribeSheet(); // Ensure previous listener is cleared if switching away from sheet
                }
                fetchResultsHistory(); // Start listening for sheet data before rendering
            } else if (currentPage === 'sheet' && unsubscribeSheet) {
                 unsubscribeSheet(); // Clear sheet listener when navigating away
                 unsubscribeSheet = null;
            }
            currentPage = page;
            updateUI();
        };
        
        window.resetTestAndGoToPage = (page) => {
            currentAnswers = discQuestions.map(() => ({ most: null, least: null }));
            profileResult = null;
            goToPage(page);
        };

        const updateUI = () => {
            const appContainer = document.getElementById('app-container');
            if (!appContainer) return;

            let content = '';
            if (!isAuthReady) {
                content = '<div class="text-center text-xl text-blue-600 p-12">Memuat konfigurasi keamanan dan basis data...</div>';
            } else {
                switch (currentPage) {
                    case 'welcome':
                        content = renderWelcome();
                        break;
                    case 'test':
                        content = renderTest();
                        break;
                    case 'results':
                        content = renderResults();
                        break;
                    case 'sheet':
                        content = renderSheet();
                        break;
                    default:
                        content = renderWelcome();
                }
            }
            appContainer.innerHTML = content;
        };
        
        // Expose necessary functions globally for HTML event handlers
        window.handleSelection = handleSelection;
        window.handleSubmitTest = handleSubmitTest;

        // Initialize on window load
        window.onload = initializeFirebase;

    </script>
    <style>
        .form-checkbox:checked {
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
        }
    </style>
</head>
<body class="min-h-screen bg-gray-100 p-4 sm:p-8 flex items-center justify-center font-sans">
    <div id="app-container" class="w-full">
        <!-- Content will be rendered here by JavaScript -->
        <div class="text-center text-xl text-blue-600 p-12">Memuat...</div>
    </div>
</body>
</html>
