<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tes Profil DISC - Pengiriman Data</title>
    <!-- Load Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script type="module">
        // --- KONFIGURASI PENGIRIMAN DATA (SUDAH DIPERBAIKI) ---
        // Ganti URL ini dengan URL 'action' dari Google Form atau Formspree Anda.
        const FORM_ENDPOINT = "<iframe src="https://docs.google.com/forms/d/e/1FAIpQLSdmbhQQiXNgOs_gifS8K_1HG2ppND9vmHBbn3ZdXmlT41oUQQ/formResponse"; 
        
        // Nama-nama ini HARUS cocok dengan nama input yang dihasilkan oleh Google Form Anda.
        const FIELD_NAMES = {
            PROFILE: "entry.1582113093",      // Field untuk Profil Utama
            D: "entry.239356283",            // Field untuk Skor Dominance (D)
            I: "entry.1255192217",            // Field untuk Skor Influence (I)
            S: "entry.871442160",            // Field untuk Skor Steadiness (S)
            C: "entry.1854576989",            // Field untuk Skor Conscientiousness (C)
            CANDIDATE_ID: "entry.1140320701" // Field untuk ID Kandidat/Sesi
        };
        // -----------------------------------------------

        // Define DISC question set
        const discQuestions = [
            { id: 1, choices: { D: "Mendorong", I: "Ramah", S: "Tenang", C: "Akurat" } },
            { id: 2, choices: { D: "Tegas", I: "Optimis", S: "Sabar", C: "Analitis" } },
            { id: 3, choices: { D: "Kuat", I: "Ekspresif", S: "Stabil", C: "Logis" } },
            { id: 4, choices: { D: "Berani", I: "Antusias", S: "Konsisten", C: "Perfeksionis" } },
            { id: 5, choices: { D: "Menantang", I: "Sosial", S: "Penuh Perhatian", C: "Hati-hati" } },
            { id: 6, choices: { D: "Berorientasi Hasil", I: "Persuasif", S: "Setia", C: "Tepat" } },
            { id: 7, choices: { D: "Independen", I: "Ceria", S: "Pendengar yang Baik", C: "Teratur" } },
            { id: 8, choices: { D: "Lugas", I: "Komunikatif", S: "Damai", C: "Kritis" } },
            { id: 9, choices: { D: "Bertekad", I: "Fleksibel", S: "Mudah Diajak Kerjasama", C: "Teliti" } },
            { id: 10, choices: { D: "Inovatif", I: "Spontan", S: "Hormat", C: "Standar Tinggi" } },
        ];
        
        // --- APPLICATION STATE (Global Variables) ---
        let sessionId = crypto.randomUUID(); // Menggunakan UUID acak sebagai ID Sesi
        let currentPage = 'welcome';
        let currentAnswers = discQuestions.map(() => ({ most: null, least: null }));
        let profileResult = null;

        // --- DISC LOGIC ---

        const handleSelection = (questionIndex, type, value) => {
            const currentQ = currentAnswers[questionIndex];
            
            if (type === 'most') {
                if (currentQ.least === value) {
                    currentQ.least = null;
                }
                currentQ.most = value;
            } else { // type === 'least'
                if (currentQ.most === value) {
                    currentQ.most = null;
                }
                currentQ.least = value;
            }
            updateUI();
        };
        
        const calculateDISC = () => {
            const scores = { D: 0, I: 0, S: 0, C: 0 };
            currentAnswers.forEach((answer, index) => {
                const choices = discQuestions[index].choices;
                if (answer.most) {
                    const type = Object.keys(choices).find(key => choices[key] === answer.most);
                    if (type) scores[type] += 1;
                }
                if (answer.least) {
                    const type = Object.keys(choices).find(key => choices[key] === answer.least);
                    if (type) scores[type] -= 1;
                }
            });

            const sortedScores = Object.entries(scores).sort(([, a], [, b]) => b - a);
            const maxScore = sortedScores[0][1];
            const primaryRawType = sortedScores.filter(([, score]) => score === maxScore).map(([type]) => type).join('/');
            
            const primaryProfileMap = {
                D: 'Dominance (Kekuasaan)', I: 'Influence (Pengaruh)', S: 'Steadiness (Keteguhan)', C: 'Conscientiousness (Kepatuhan)',
                'D/I': 'Dominance/Influence (Pendorong & Persuasif)', 'I/D': 'Influence/Dominance (Persuasif & Pendorong)', 
                'S/C': 'Steadiness/Conscientiousness (Teliti & Stabil)', 'C/S': 'Conscientiousness/Steadiness (Teliti & Stabil)',
                'D/S': 'Dominance/Steadiness (Tegas & Stabil)', 'I/S': 'Influence/Steadiness (Ramah & Stabil)',
                'I/C': 'Influence/Conscientiousness (Ramah & Teliti)', 'C/D': 'Conscientiousness/Dominance (Teliti & Tegas)'
            };
            
            const finalPrimaryKey = primaryRawType.split('/').sort().join('/');

            return {
                scores: scores,
                primaryType: primaryProfileMap[finalPrimaryKey] || primaryProfileMap[primaryRawType] || primaryProfileMap[primaryRawType.split('/')[0]],
                rawProfile: primaryRawType,
            };
        };

        const handleSubmitTest = async () => {
            const isComplete = currentAnswers.every(a => a.most !== null && a.least !== null);
            if (!isComplete) {
                const appContainer = document.getElementById('app-container');
                appContainer.insertAdjacentHTML('afterbegin', `
                    <div id="error-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div class="bg-white p-6 rounded-lg shadow-2xl">
                            <h3 class="text-xl font-bold text-red-600 mb-4">Tes Belum Selesai!</h3>
                            <p>Harap jawab semua 10 pertanyaan sebelum mengirim.</p>
                            <button onclick="document.getElementById('error-modal').remove()" class="mt-4 px-4 py-2 bg-red-500 text-white rounded">Tutup</button>
                        </div>
                    </div>
                `);
                return;
            }

            const result = calculateDISC();
            profileResult = result;
            
            // --- LOGIKA PENGIRIMAN FORM KE SHEET ---
            
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = FORM_ENDPOINT;
            form.style.display = 'none';
            form.target = '_blank'; // FIX: Mencegah pengalihan halaman utama
            
            // Data yang akan dikirim
            const data = {
                [FIELD_NAMES.CANDIDATE_ID]: sessionId,
                [FIELD_NAMES.PROFILE]: result.primaryType,
                [FIELD_NAMES.D]: result.scores.D,
                [FIELD_NAMES.I]: result.scores.I,
                [FIELD_NAMES.S]: result.scores.S,
                [FIELD_NAMES.C]: result.scores.C,
            };

            // Masukkan data ke input tersembunyi
            for (const key in data) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = data[key];
                form.appendChild(input);
            }

            // Tambahkan form ke body dan kirim
            document.body.appendChild(form);
            form.submit(); // Mengirim data ke Google Sheet
            document.body.removeChild(form); // Hapus form setelah dikirim

            // Update UI
            currentPage = 'results';
            updateUI();
        };

        // --- RENDERING FUNCTIONS (UI) ---

        const renderWelcome = () => {
            return `
                <div class="text-center p-8 bg-white shadow-xl rounded-xl w-full max-w-xl">
                    <h1 class="text-3xl font-extrabold text-blue-700 mb-4">Tes Profil DISC</h1>
                    <p class="text-gray-600 mb-6">Tes ini akan membantu mengidentifikasi kecenderungan perilaku Anda dalam empat dimensi utama: Dominance (D), Influence (I), Steadiness (S), dan Conscientiousness (C).</p>
                    
                    <!-- Peringatan Konfigurasi untuk Admin (SUDAH DIHAPUS) -->

                    <div class="text-left mb-6 p-4 border-l-4 border-yellow-500 bg-yellow-50 rounded">
                        <p class="font-semibold text-yellow-700">Instruksi Tes:</p>
                        <ul class="list-disc list-inside text-gray-700 text-sm mt-2">
                            <li>Anda akan memilih <strong>SATU</strong> kata yang <strong>PALING</strong> menggambarkan diri Anda.</li>
                            <li>Dan <strong>SATU</strong> kata yang <strong>PALING TIDAK</strong> menggambarkan diri Anda.</li>
                            <li>Pastikan Anda memilih <strong>kedua</strong> opsi (Paling dan Paling Tidak) di setiap nomor.</li>
                        </ul>
                    </div>

                    <button
                        onclick="goToPage('test')"
                        class="px-8 py-3 bg-blue-600 text-white font-bold rounded-lg shadow-lg hover:bg-blue-700 transition duration-300 transform hover:scale-105"
                    >
                        Mulai Tes
                    </button>
                    <p class="mt-4 text-sm text-gray-500">ID Sesi Anda: ${sessionId}</p>
                </div>
            `;
        };
        
        const renderTest = () => {
            const completedCount = currentAnswers.filter(a => a.most !== null && a.least !== null).length;
            
            const questionHtml = discQuestions.map((q, index) => {
                const choicesHtml = Object.values(q.choices).map((choice, choiceIndex) => {
                    const isMostSelected = currentAnswers[index].most === choice;
                    const isLeastSelected = currentAnswers[index].least === choice;
                    const isDisabled = (isMostSelected && isLeastSelected); 

                    return `
                        <div class="flex flex-col p-3 rounded-lg transition duration-150 ${isDisabled ? 'bg-gray-100' : 'bg-gray-50 hover:bg-gray-100'}" data-choice="${choice}">
                            <span class="font-medium text-gray-700 mb-2">${choice}</span>
                            <div class="flex space-x-3">
                                <label class="flex items-center space-x-1 cursor-pointer">
                                    <input
                                        type="checkbox"
                                        onchange="window.handleSelection(${index}, 'most', '${choice}')"
                                        ${isMostSelected ? 'checked' : ''}
                                        ${isLeastSelected || isDisabled ? 'disabled' : ''}
                                        class="form-checkbox h-5 w-5 ${isLeastSelected ? 'text-gray-400' : 'text-green-500'}"
                                    />
                                    <span class="text-sm">Paling</span>
                                </label>
                                <label class="flex items-center space-x-1 cursor-pointer">
                                    <input
                                        type="checkbox"
                                        onchange="window.handleSelection(${index}, 'least', '${choice}')"
                                        ${isLeastSelected ? 'checked' : ''}
                                        ${isMostSelected || isDisabled ? 'disabled' : ''}
                                        class="form-checkbox h-5 w-5 ${isMostSelected ? 'text-gray-400' : 'text-red-500'}"
                                    />
                                    <span class="text-sm">Paling Tidak</span>
                                </label>
                            </div>
                        </div>
                    `;
                }).join('');

                const warning = !(currentAnswers[index].most && currentAnswers[index].least) ? 
                    `<p class="mt-3 text-red-500 text-xs font-medium">Harap pilih satu "Paling" dan satu "Paling Tidak".</p>` : '';

                return `
                    <div class="p-4 border border-gray-200 rounded-lg shadow-sm hover:shadow-md transition duration-200">
                        <p class="font-semibold text-lg mb-4 text-blue-600">Pertanyaan ${q.id}. Pilih SATU Paling dan SATU Paling Tidak:</p>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">${choicesHtml}</div>
                        ${warning}
                    </div>
                `;
            }).join('');

            const isComplete = completedCount === discQuestions.length;
            const buttonClass = isComplete ? 'bg-green-600 hover:bg-green-700' : 'bg-gray-400 cursor-not-allowed';

            return `
                <div class="p-4 md:p-8 bg-white shadow-xl rounded-xl max-w-4xl mx-auto w-full">
                    <h1 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-3">Sesi Tes DISC (${completedCount}/${discQuestions.length} Terjawab)</h1>
                    <p class="mb-4 text-sm text-gray-600">ID Sesi: <span class="font-mono text-xs p-1 bg-gray-200 rounded break-all">${sessionId}</span></p>

                    <div class="grid grid-cols-1 gap-8">${questionHtml}</div>

                    <div class="mt-8 flex justify-center">
                        <button
                            onclick="window.handleSubmitTest()"
                            ${!isComplete ? 'disabled' : ''}
                            class="px-10 py-4 ${buttonClass} text-white font-bold text-lg rounded-lg shadow-lg transition duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed"
                        >
                            Kirim Hasil ke Sheet & Lihat Ringkasan
                        </button>
                    </div>
                </div>
            `;
        };
        
        const renderResults = () => {
            if (!profileResult) return '<p class="text-center text-red-500">Hasil tidak ditemukan.</p>';

            const { primaryType, rawScores, rawProfile } = profileResult;
            
            const profileColorMap = {
                D: 'bg-red-500', I: 'bg-yellow-500', S: 'bg-green-500', C: 'bg-blue-500',
                'D/I': 'bg-gradient-to-r from-red-500 to-yellow-500',
                'I/D': 'bg-gradient-to-r from-yellow-500 to-red-500',
                'S/C': 'bg-gradient-to-r from-green-500 to-blue-500',
                'C/S': 'bg-gradient-to-r from-blue-500 to-green-500',
                'D/S': 'bg-gradient-to-r from-red-500 to-green-500',
                'I/S': 'bg-gradient-to-r from-yellow-500 to-green-500',
                'I/C': 'bg-gradient-to-r from-yellow-500 to-blue-500',
                'C/D': 'bg-gradient-to-r from-blue-500 to-red-500',
            };
            const profileDescMap = {
                'Dominance (Kekuasaan)': 'Berorientasi pada hasil, tegas, pemecah masalah, dan menyukai tantangan.',
                'Influence (Pengaruh)': 'Sosial, optimis, antusias, dan persuasif. Suka bekerja dalam tim.',
                'Steadiness (Keteguhan)': 'Sabar, tenang, setia, suportif, dan menghargai stabilitas.',
                'Conscientiousness (Kepatuhan)': 'Analitis, akurat, hati-hati, fokus pada kualitas dan detail.',
            };

            const getPrimaryTypeClass = () => {
                const types = rawProfile.split('/');
                if (types.length === 1) return profileColorMap[types[0]] || 'bg-gray-400';
                const sortedType = types.sort().join('/'); 
                return profileColorMap[sortedType] || profileColorMap[rawProfile] || 'bg-gray-400';
            };
            
            const scoreHtml = Object.entries(rawScores).map(([type, score]) => `
                <div class="text-center p-4 border rounded-lg shadow-md bg-white">
                    <p class="text-lg font-semibold text-gray-700">${type}</p>
                    <p class="text-4xl font-extrabold text-blue-600 mt-1">${score}</p>
                </div>
            `).join('');

            return `
                <div class="p-8 bg-white shadow-2xl rounded-xl max-w-4xl mx-auto w-full">
                    <h1 class="text-3xl font-extrabold text-green-700 text-center mb-6">HASIL TES PROFIL DISC ANDA</h1>
                    
                    <div class="text-center p-6 mb-8 rounded-lg shadow-inner bg-blue-50 border border-blue-200">
                        <p class="text-xl text-gray-700 mb-2">Profil Dominan Anda adalah:</p>
                        <h2 class="text-4xl font-black text-white p-4 rounded-lg inline-block ${getPrimaryTypeClass()} shadow-xl">
                            ${primaryType}
                        </h2>
                        <p class="mt-4 text-gray-600 italic">${profileDescMap[primaryType.split('(')[0].trim()] || "Lihat skor di bawah untuk detail lebih lanjut."}</p>
                    </div>
                    
                    <div class="text-center p-4 bg-green-50 border border-green-200 rounded-lg mb-8">
                        <p class="font-bold text-green-700">PENGIRIMAN DATA BERHASIL!</p>
                        <p class="text-sm text-gray-700">Hasil skor telah dikirim ke Google Sheet Anda. Silakan cek spreadsheet tersebut.</p>
                        <p class="text-xs text-gray-500 mt-1">ID Sesi: ${sessionId}</p>
                    </div>


                    <h3 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Skor Anda:</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">${scoreHtml}</div>

                    <div class="flex justify-center">
                        <button
                            onclick="window.resetTestAndGoToPage('test')"
                            class="px-6 py-3 border border-blue-600 text-blue-600 font-semibold rounded-lg hover:bg-blue-50 transition duration-300"
                        >
                            Ulangi Tes
                        </button>
                    </div>
                </div>
            `;
        };
        
        // Halaman 'Sheet' dihilangkan karena data dikirim ke luar.
        // Fungsi ini hanya berfungsi sebagai navigasi.
        const goToPage = (page) => {
            if (page === 'sheet') {
                // Di aplikasi baru ini, 'sheet' redirect ke 'results'
                page = 'results';
            }
            currentPage = page;
            updateUI();
        };
        
        const resetTestAndGoToPage = (page) => {
            currentAnswers = discQuestions.map(() => ({ most: null, least: null }));
            profileResult = null;
            sessionId = crypto.randomUUID(); // Buat ID sesi baru
            goToPage(page);
        };

        const updateUI = () => {
            const appContainer = document.getElementById('app-container');
            if (!appContainer) return;

            let content = '';
            switch (currentPage) {
                case 'welcome':
                    content = renderWelcome();
                    break;
                case 'test':
                    content = renderTest();
                    break;
                case 'results':
                    content = renderResults();
                    break;
                default:
                    content = renderWelcome();
            }
            appContainer.innerHTML = content;
        };
        
        // Expose necessary functions globally for HTML event handlers
        window.handleSelection = handleSelection;
        window.handleSubmitTest = handleSubmitTest;
        window.goToPage = goToPage; // Tetap ada untuk navigasi internal
        window.resetTestAndGoToPage = resetTestAndGoToPage;

        // FIX: Use DOMContentLoaded listener for better reliability than window.onload
        document.addEventListener('DOMContentLoaded', updateUI);

    </script>
    <style>
        .form-checkbox:checked {
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
        }
    </style>
</head>
<body class="min-h-screen bg-gray-100 p-4 sm:p-8 flex items-center justify-center font-sans">
    <div id="app-container" class="w-full">
        <!-- Content will be rendered here by JavaScript -->
        <div class="text-center text-xl text-blue-600 p-12">Memuat...</div>
    </div>
</body>
</html>
